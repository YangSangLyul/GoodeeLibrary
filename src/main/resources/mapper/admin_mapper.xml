<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="com.spring.main.dao.AdminDAO">

	<!-- 이 달의 리뷰왕 -->
	<select id="ReviewKing" resultType="com.spring.main.dto.AdminDTO" parameterType="list">
		<![CDATA[
			SELECT * FROM (
			    SELECT ROW_NUMBER() OVER(ORDER BY COUNT(r.id) DESC) AS rnum, r.id, COUNT(r.id) "up" FROM ReviewRecommend c JOIN review r 
			    ON c.reviewIdx = r.reviewIdx AND TO_CHAR(c.recom_date,'YYYYMM') = TO_CHAR(add_months(sysdate,-1), 'YYYYMM') GROUP BY r.id
			) WHERE rnum <= 3
			UNION
			SELECT * FROM (
			    SELECT ROW_NUMBER() OVER(ORDER BY COUNT(id) DESC) AS rnum,
			        id, COUNT(id) AS "reviewcnt" FROM review WHERE TO_CHAR(reg_date,'YYYYMM') = TO_CHAR(add_months(sysdate,-1), 'YYYYMM')
			        GROUP BY id
			) WHERE rnum <= 3
		]]>
	</select>
	
</mapper>